<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal News Intelligence</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=2.4">
    <link rel="stylesheet" href="/static/selection_menu.css">
    <link rel="stylesheet" href="/static/newspaper.css">
    <link rel="stylesheet" href="/static/trending.css">
    <style>
        /* Force Chatbot Positioning */
        #chat-toggle {
            position: fixed !important;
            bottom: 30px !important;
            right: 30px !important;
            z-index: 10000 !important;
        }

        #chat-widget {
            position: fixed !important;
            bottom: 105px !important;
            right: 30px !important;
            z-index: 10000 !important;
            background: #0f172a !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        #chat-header {
            background: #1e293b !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        #chat-header span {
            color: white !important;
        }

        #chat-messages {
            background: #0f172a !important;
        }

        #chat-input-area {
            background: #1e293b !important;
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        #chat-input {
            background: #020617 !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">Universal News Intelligence</div>
            <div class="date">üìÖ {{ date }} ‚Ä¢ 15-Minute Update Cycle {% if digest.generated_at %}‚Ä¢ Last Updated: {{
                digest.generated_at[11:16] }} UTC{% endif %}</div>
            <div id="auth-section" class="profile-container">
                <button id="login-btn" class="btn-premium">Login</button>
                <div id="user-info" class="user-profile-widget" style="display: none;">
                    <div class="profile-left">
                        <div class="avatar-wrapper" id="avatar-container">
                            <img id="user-avatar-img" src="https://ui-avatars.com/api/?background=random" alt="User"
                                onerror="handleAvatarError()">
                            <div class="status-badge"></div>
                        </div>
                        <div class="user-meta">
                            <span id="user-display">User Name</span>
                            <span class="status-text">Online</span>
                        </div>
                    </div>
                    <button class="menu-btn" id="profile-menu-toggle">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path
                                d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
                        </svg>
                    </button>
                    <!-- Simple Dropdown for actions -->
                    <div id="profile-dropdown" class="profile-dropdown">
                        <button id="saved-btn" class="dropdown-item">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                            Saved Items
                        </button>
                        <button id="history-btn" class="dropdown-item">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Reading History
                        </button>
                        <button id="notify-btn" class="dropdown-item">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path
                                    d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 4.36 6 6.92 6 10v5l-2 2v1h16v-1l-2-2z" />
                            </svg>
                            Notifications
                        </button>
                        <button id="logout-btn" class="dropdown-item logout">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        {% if not digest %}
        <div class="empty-state" style="text-align: center; margin-top: 5rem;">
            <h2>System Initializing...</h2>
            <p>Collecting universal data from global sources. Please wait.</p>
        </div>
        {% else %}

        <!-- Daily Insight -->
        <section class="insight-section">
            <h2>üß† Daily Executive Brief</h2>
            <p>{{ digest.insight }}</p>
        </section>

        <!-- 60-Second Brief -->
        {% if digest.brief %}
        <section class="brief-60s">
            <div class="brief-container">
                <div class="brief-header">
                    <h2>‚≠ê 60-Second Brief</h2>
                    <span class="brief-tag">Ultra-Consumable ‚Ä¢ 5 Points</span>
                </div>
                <div class="brief-list">
                    {% for point in digest.brief %}
                    <div class="brief-item" onclick="trackRead('{{ point.id }}')">
                        <span class="brief-marker">‚óè</span>
                        <a href="#news-{{ point.id }}" class="brief-link">{{ point.title }}</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Daily Newspapers Section -->
        <section class="newspaper-section">
            <div class="newspaper-header">
                <h2 class="section-title">üì∞ Today's Newspapers</h2>
                <div class="newspaper-update-time">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span>Updates daily at 6:30 AM IST</span>
                </div>
            </div>
            <div class="newspaper-grid">
                <a href="https://www.bbc.com/news" target="_blank" class="newspaper-card">
                    <div class="newspaper-logo bbc">
                        <span>BBC</span>
                    </div>
                    <div class="newspaper-info">
                        <h3>BBC News</h3>
                        <p>British Broadcasting Corporation</p>
                        <span class="newspaper-badge">International</span>
                    </div>
                </a>

                <a href="https://edition.cnn.com/" target="_blank" class="newspaper-card">
                    <div class="newspaper-logo cnn">
                        <span>CNN</span>
                    </div>
                    <div class="newspaper-info">
                        <h3>CNN International</h3>
                        <p>Cable News Network</p>
                        <span class="newspaper-badge">International</span>
                    </div>
                </a>

                <a href="https://www.news18.com/" target="_blank" class="newspaper-card">
                    <div class="newspaper-logo news18">
                        <span>News18</span>
                    </div>
                    <div class="newspaper-info">
                        <h3>News18 India</h3>
                        <p>Indian News Network</p>
                        <span class="newspaper-badge india">India</span>
                    </div>
                </a>

                <a href="https://www.timesnownews.com/" target="_blank" class="newspaper-card">
                    <div class="newspaper-logo timesnow">
                        <span>Times Now</span>
                    </div>
                    <div class="newspaper-info">
                        <h3>Times Now</h3>
                        <p>Times Network</p>
                        <span class="newspaper-badge india">India</span>
                    </div>
                </a>
            </div>
        </section>

        <!-- Trending in India (24 Hours) -->
        <section class="trending-india-section">
            <div class="trending-header">
                <div class="trending-title-group">
                    <h2 class="section-title">üî• Trending in India</h2>
                    <span class="trending-subtitle">High-Impact Social Media News ‚Ä¢ Last 24 Hours</span>
                </div>
                <div class="trending-platforms">
                    <span class="platform-badge google-news">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                            <path
                                d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z">
                            </path>
                        </svg>
                        Google News
                    </span>
                    <span class="platform-badge reddit">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                        Reddit
                    </span>
                </div>
            </div>

            <div class="trending-grid">
                {% if digest.trending_news %}
                {% for item in digest.trending_news %}
                <div class="trending-card" id="trending-{{ item.id }}" onclick="trackRead('{{ item.id }}')">
                    <div class="trending-badge trending">TRENDING</div>
                    <div class="trending-content">
                        <h3>{{ item.title }}</h3>
                        <p>{{ item.summary }}</p>
                        <div class="trending-meta">
                            <span class="platform-icon google-icon">üì∞</span>
                            <span class="engagement">{{ item.source_name }}</span>
                            <span class="engagement">‚Ä¢ {{ item.engagement }}</span>
                            <span class="time">{{ item.time_ago }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">No trending news currently available.</div>
                {% endif %}
            </div>

            <div class="trending-note">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>Trending topics refresh every 24 hours based on social media engagement and impact</span>
            </div>
        </section>

        <!-- Top Stories -->
        <section style="margin-bottom: 4rem;">
            <h2 class="section-title">üî• Top 10 Headlines</h2>
            <div class="cards-grid">
                {% for story in digest.top_stories %}
                <div class="card" id="news-{{ story.id }}" data-news-id="{{ story.id }}"
                    onclick="trackRead('{{ story.id }}')">
                    <button class="save-btn" onclick="toggleSave(event, '{{ story.id }}')" title="Save for later">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <a href="{{ story.url }}" target="_blank"
                        style="text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%;">
                        {% if story.image_url %}
                        <div class="card-image-container">
                            <img src="{{ story.image_url }}" alt="News Image" class="card-image"
                                onerror="this.style.display='none'">
                        </div>
                        {% endif %}
                        <div class="card-content">
                            <div class="publisher-info">
                                <span class="source-name">üîç Verified: {{ story.source_name }}</span>
                            </div>
                            <h3>{{ story.title }}</h3>

                            <!-- Tags & Bias -->
                            <div class="tags-container">
                                {% if story.tags %}
                                {% for tag in story.tags %}
                                <span class="impact-tag">{{ tag }}</span>
                                {% endfor %}
                                {% endif %}
                                {% if story.bias and story.bias != "Neutral" %}
                                <span class="bias-tag">{{ story.bias }}</span>
                                {% endif %}
                            </div>

                            <ul class="bullets">
                                {% for bullet in story.bullets %}
                                <li>{{ bullet }}</li>
                                {% endfor %}
                            </ul>
                            <div class="impact-grid">
                                <div class="impact-item">
                                    <strong>üë§ Who is Affected</strong>
                                    <p>{{ story.affected or "General Public" }}</p>
                                </div>
                                <div class="impact-item">
                                    <strong>‚è±Ô∏è Short-Term</strong>
                                    <p>{{ story.short_impact or "Initial local awareness." }}</p>
                                </div>
                                <div class="impact-item">
                                    <strong>üî≠ Long-Term</strong>
                                    <p>{{ story.long_impact or "Potential shifts in policy or behavior." }}</p>
                                </div>
                            </div>
                            <div class="why-matters">
                                <strong>üí° Why it matters</strong>
                                {{ story.why }}
                            </div>
                        </div>
                        <div class="safety-disclosure">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            AI-generated summary. Verify at {{ story.source_name }}.
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Color Coded Categories -->
        {% set category_order = [
        "Breaking News", "Politics", "Business & Economy", "Sports",
        "Technology", "AI & Machine Learning", "World News", "India / Local News",
        "Science & Health", "Education", "Entertainment",
        "Environment & Climate", "Lifestyle & Wellness", "Defense & Security"
        ] %}

        {% for cat_name in category_order %}
        {% if cat_name in digest.categories and digest.categories[cat_name] %}
        {% set slug = cat_name|lower|replace(" & ", "-")|replace(" / ", "-")|replace(" ", "-") %}

        <section class="category-section cat-{{ slug }}">
            <h2 class="section-title" style="margin-top:0;">{{ cat_name }}</h2>
            <div class="cards-grid">
                {% for item in digest.categories[cat_name] %}
                <div class="card" id="news-{{ item.id }}" data-news-id="{{ item.id }}"
                    onclick="trackRead('{{ item.id }}')">
                    <button class="save-btn" onclick="toggleSave(event, '{{ item.id }}')" title="Save for later">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <a href="{{ item.url }}" target="_blank"
                        style="text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%;">
                        {% if item.image_url %}
                        <div class="card-image-container">
                            <img src="{{ item.image_url }}" alt="News Image" class="card-image"
                                onerror="this.style.display='none'">
                        </div>
                        {% endif %}
                        <div class="card-content">
                            <div class="publisher-info">
                                <span class="source-name">üîç {{ item.source_name }}</span>
                            </div>
                            <h3>{{ item.title }}</h3>

                            <div class="tags-container">
                                {% if item.tags %}
                                {% for tag in item.tags %}
                                <span class="impact-tag">{{ tag }}</span>
                                {% endfor %}
                                {% endif %}
                                {% if item.bias and item.bias != "Neutral" %}
                                <span class="bias-tag">{{ item.bias }}</span>
                                {% endif %}
                            </div>

                            <ul class="bullets">
                                <li>{{ item.why }}</li>
                            </ul>
                            <div class="impact-mini">
                                <span>üë§ {{ item.affected[:40] }}{% if item.affected|length > 40 %}...{% endif %}</span>
                            </div>
                        </div>
                        <div class="safety-disclosure">
                            AI-generated summary. Source links provided.
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endfor %}
        {% endif %}

        <footer class="safety-footer">
            <div class="safety-footer-message">
                ‚öñÔ∏è <strong>Mandatory Disclosure:</strong> AI-generated summaries may be imperfect. Original source links
                are provided for verification and full context. Use the "Verified Source" tags to view original
                publisher content.
            </div>
            <div style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.6;">
                ¬© 2026 Universal News Intelligence Agent ‚Ä¢ Powered by Advanced LLM Orchestration
            </div>
        </footer>
    </div>

    <!-- AI Chatbot Interface (Fixed Positioning Root) -->
    <div id="chat-widget" class="chat-closed">
        <div id="chat-header">
            <div class="header-info">
                <div class="status-dot"></div>
                <span>News Intelligence AI</span>
            </div>
            <button id="close-chat">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type your message...">
            <button id="send-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>
    <button id="chat-toggle">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
        </svg>
        <span style="font-weight: 600; margin-left: 8px; font-size: 0.9rem;">Intelligence AI</span>
    </button>

    <script>
        const chatToggle = document.getElementById('chat-toggle');
        const chatWidget = document.getElementById('chat-widget');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const closeChat = document.getElementById('close-chat');

        function handleAvatarError() {
            const img = document.getElementById('user-avatar-img');
            const container = document.getElementById('avatar-container');
            const userName = document.getElementById('user-display').innerText || 'U';
            const initial = userName.charAt(0).toUpperCase();

            img.style.display = 'none';
            const fallback = document.createElement('div');
            fallback.className = 'initial-avatar';
            fallback.innerText = initial;
            container.prepend(fallback);
        }

        chatToggle.onclick = () => {
            chatWidget.classList.toggle('chat-open');
            chatWidget.classList.toggle('chat-closed');
        };

        closeChat.onclick = () => {
            chatWidget.classList.add('chat-closed');
            chatWidget.classList.remove('chat-open');
        };

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            chatInput.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();
                addMessage(data.response, 'bot');
            } catch (e) {
                addMessage('Error connecting to AI.', 'bot');
            }
        }

        function addMessage(text, side) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + side;
            div.style.padding = '0.8rem';
            div.style.borderRadius = '12px';
            div.style.marginBottom = '0.5rem';
            div.style.maxWidth = '85%';
            div.style.fontSize = '0.9rem';
            div.style.whiteSpace = 'pre-wrap';

            if (side === 'user') {
                div.style.alignSelf = 'flex-end';
                div.style.background = '#e0f2fe';
                div.style.color = '#0369a1';
            } else {
                div.style.alignSelf = 'flex-start';
                div.style.background = '#f1f5f9';
                div.style.color = '#1e293b';

                // Transparency Layer
                const disclosure = document.createElement('div');
                disclosure.style.fontSize = '0.7rem';
                disclosure.style.opacity = '0.6';
                disclosure.style.marginTop = '4px';
                disclosure.style.fontStyle = 'italic';
                disclosure.innerText = "AI response. Verify facts with source links.";
                div.appendChild(document.createTextNode(text));
                div.appendChild(disclosure);
            }
            if (side === 'user') div.innerText = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Retention Features
        async function toggleSave(event, newsId) {
            event.stopPropagation();
            event.preventDefault();
            const btn = event.currentTarget;
            const user = firebase.auth().currentUser;
            if (!user) {
                alert("Please login to save articles.");
                return;
            }

            try {
                const response = await fetch('/api/retention/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firebase_uid: user.uid,
                        news_id: parseInt(newsId)
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    btn.classList.add('saved');
                    btn.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`;
                }
            } catch (e) {
                console.error("Save error", e);
            }
        }

        async function trackRead(newsId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                await fetch('/api/retention/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firebase_uid: user.uid,
                        news_id: parseInt(newsId)
                    })
                });
            } catch (e) {
                console.error("History track error", e);
            }
        }

        sendBtn.onclick = sendMessage;

        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

        // --- Firebase Integration ---
        const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey }}",
            authDomain: "{{ firebase_config.authDomain }}",
            projectId: "{{ firebase_config.projectId }}",
            storageBucket: "{{ firebase_config.storageBucket }}",
            messagingSenderId: "{{ firebase_config.messagingSenderId }}",
            appId: "{{ firebase_config.appId }}"
        };

        // Load Firebase SDKs dynamically or via CDN
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script>
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const messaging = firebase.messaging();

        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const notifyBtn = document.getElementById('notify-btn');
        const userInfo = document.getElementById('user-info');
        const userDisplay = document.getElementById('user-display');

        // Multi-provider login
        let isLoggingIn = false;
        loginBtn.onclick = async (e) => {
            if (isLoggingIn) return;
            isLoggingIn = true;
            const originalText = loginBtn.innerText;
            loginBtn.innerText = 'Signing in...';
            loginBtn.style.opacity = '0.5';
            loginBtn.disabled = true;

            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const idToken = await result.user.getIdToken();
                await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_token: idToken })
                });
            } catch (e) {
                if (e.code !== 'auth/cancelled-popup-request' && e.code !== 'auth/popup-closed-by-user') {
                    console.error("Login failed", e);
                }
            } finally {
                isLoggingIn = false;
                loginBtn.innerText = originalText;
                loginBtn.style.opacity = '1';
                loginBtn.disabled = false;
            }
        };

        logoutBtn.onclick = () => {
            auth.signOut().then(() => {
                window.location.href = '/';
            });
        };

        auth.onAuthStateChanged(async user => {
            if (user) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';

                const displayName = user.displayName || user.email || user.phoneNumber || "User";
                userDisplay.innerText = displayName.split('@')[0];

                if (user.photoURL) {
                    document.getElementById('user-avatar-img').src = user.photoURL;
                }

                // Auto-sync with local DB to ensure retention features work
                try {
                    const idToken = await user.getIdToken();
                    await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_token: idToken })
                    });
                } catch (e) {
                    console.error("Auto-registration failed", e);
                }
            } else {
                // Auth Gating: Redirect to login page if no session
                window.location.href = '/';
            }
        });

        // Dropdown toggle
        const menuToggle = document.getElementById('profile-menu-toggle');
        const dropdown = document.getElementById('profile-dropdown');
        menuToggle.onclick = (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        };
        window.onclick = () => dropdown.classList.remove('show');

        notifyBtn.onclick = async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await messaging.getToken({ vapidKey: '{{ vapid_public_key }}' });
                    if (token) {
                        await fetch('/api/subscribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: auth.currentUser.uid,
                                push_token: token,
                                categories: ["All"]
                            })
                        });
                        alert('Notifications enabled!');
                    }
                }
            } catch (e) {
                console.error('Notification permission error', e);
            }
        };

        const savedBtn = document.getElementById('saved-btn');
        const historyBtn = document.getElementById('history-btn');

        if (savedBtn) {
            savedBtn.onclick = () => {
                window.location.href = '/saved';
            };
        }

        if (historyBtn) {
            historyBtn.onclick = () => {
                window.location.href = '/history';
            };
        }

        // Auto-refresh the page every 2 minutes to show new news
        setTimeout(() => {
            console.log("Refreshing dashboard for new news...");
            window.location.reload();
        }, 120000); // 120,000ms = 2 minutes
    </script>
    <script src="/static/selection_menu.js"></script>
</body>

</html>